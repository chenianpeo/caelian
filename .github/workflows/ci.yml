# Minimal, robust Rust CI that auto-detects Cargo.toml
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find Cargo.toml
        id: find_manifest
        run: |
          set -euo pipefail
          # Find the first Cargo.toml tracked by git
          manifest=$(git ls-files | grep -m1 '^.*Cargo\.toml$' || true)
          if [ -z "$manifest" ]; then
            echo "manifest=" >> $GITHUB_OUTPUT
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "manifest=$manifest" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          fi

      - name: Debug manifest info
        run: |
          echo "found = ${{ steps.find_manifest.outputs.found }}"
          echo "manifest = '${{ steps.find_manifest.outputs.manifest }}'"

      - name: Install Rust toolchain
        if: steps.find_manifest.outputs.found == 'true'
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Ensure rustfmt is installed
        if: steps.find_manifest.outputs.found == 'true'
        run: rustup component add rustfmt --toolchain stable

      - name: Run rustfmt (check)
        if: steps.find_manifest.outputs.found == 'true'
        run: |
          manifest="${{ steps.find_manifest.outputs.manifest }}"
          echo "Running: cargo fmt --manifest-path \"$manifest\" --all -- --check"
          cargo fmt --manifest-path "$manifest" --all -- --check

      - name: Ensure clippy is installed
        if: steps.find_manifest.outputs.found == 'true'
        run: rustup component add clippy --toolchain stable

      - name: Run clippy
        if: steps.find_manifest.outputs.found == 'true'
        run: |
          manifest="${{ steps.find_manifest.outputs.manifest }}"
          echo "Running: cargo clippy --manifest-path \"$manifest\" --all-targets --all-features -- -D warnings"
          cargo clippy --manifest-path "$manifest" --all-targets --all-features -- -D warnings

      - name: Run tests
        if: steps.find_manifest.outputs.found == 'true'
        run: |
          manifest="${{ steps.find_manifest.outputs.manifest }}"
          echo "Running: cargo test --manifest-path \"$manifest\" --all --verbose"
          cargo test --manifest-path "$manifest" --all --verbose

      - name: Fail early if no Cargo.toml found
        if: steps.find_manifest.outputs.found == 'false'
        run: |
          echo "No Cargo.toml found in repository. Nothing to run."
          echo "Checked files:"
          git ls-files | sed -n '1,200p'
          exit 1
