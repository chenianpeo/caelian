on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find Cargo.toml (if any)
        id: find_manifest
        run: |
          set -euo pipefail
          # Find the first Cargo.toml tracked by git (any subdir)
          manifest=$(git ls-files | grep -m1 '^.*Cargo\.toml$' || true)
          if [ -z "$manifest" ]; then
            echo "no_manifest=true" >> $GITHUB_OUTPUT
          else
            manifest_dir=$(dirname "$manifest")
            echo "no_manifest=false" >> $GITHUB_OUTPUT
            echo "manifest_path=$manifest" >> $GITHUB_OUTPUT
            echo "manifest_dir=$manifest_dir" >> $GITHUB_OUTPUT
          fi

      - name: Debug: show manifest info
        if: always()
        run: |
          echo "no_manifest = ${{ steps.find_manifest.outputs.no_manifest }}"
          echo "manifest_path = ${{ steps.find_manifest.outputs.manifest_path }}"
          echo "manifest_dir = ${{ steps.find_manifest.outputs.manifest_dir }}"

      - name: Install Rust toolchain (stable)
        if: steps.find_manifest.outputs.no_manifest == 'false'
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Ensure rustfmt is installed
        if: steps.find_manifest.outputs.no_manifest == 'false'
        run: rustup component add rustfmt --toolchain stable

      - name: Run rustfmt (check)
        if: steps.find_manifest.outputs.no_manifest == 'false'
        run: |
          set -euo pipefail
          manifest_dir="${{ steps.find_manifest.outputs.manifest_dir }}"
          echo "Running cargo fmt in: $manifest_dir"
          pushd "$manifest_dir"
          cargo fmt --all -- --check
          popd

      - name: Ensure clippy is installed
        if: steps.find_manifest.outputs.no_manifest == 'false'
        run: rustup component add clippy --toolchain stable

      - name: Run Clippy
        if: steps.find_manifest.outputs.no_manifest == 'false'
        run: |
          set -euo pipefail
          manifest_dir="${{ steps.find_manifest.outputs.manifest_dir }}"
          echo "Running cargo clippy in: $manifest_dir"
          pushd "$manifest_dir"
          cargo clippy --all-targets --all-features -- -D warnings
          popd

      - name: Rust tests
        if: steps.find_manifest.outputs.no_manifest == 'false'
        run: |
          set -euo pipefail
          manifest_dir="${{ steps.find_manifest.outputs.manifest_dir }}"
          echo "Running cargo test in: $manifest_dir"
          pushd "$manifest_dir"
          cargo test --all --verbose
          popd

      - name: Install cargo-audit (optional)
        if: steps.find_manifest.outputs.no_manifest == 'false'
        run: |
          set -eux
          if ! command -v cargo-audit >/dev/null 2>&1; then
            cargo install --locked cargo-audit || true
          fi

      - name: Run cargo-audit (non-blocking)
        if: steps.find_manifest.outputs.no_manifest == 'false'
        run: |
          set -euo pipefail
          manifest_dir="${{ steps.find_manifest.outputs.manifest_dir }}"
          pushd "$manifest_dir"
          # Run cargo audit but don't fail the job on vulnerability reports yet.
          cargo audit || true
          popd

      - name: Skip Rust checks when no Cargo.toml found
        if: steps.find_manifest.outputs.no_manifest == 'true'
        run: |
          echo "No Cargo.toml found in repo; skipping rustfmt/clippy/tests steps."
